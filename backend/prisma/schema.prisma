generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model audit_logs {
  id             String   @id @db.VarChar(255)
  actor          String   @db.VarChar(255)
  action         String   @db.VarChar(100)
  entity         String   @db.VarChar(100)
  conditions     Json?
  before_data    Json?
  after_data     Json?
  success        Boolean  @default(true)
  error          String?
  execution_time Int?
  timestamp      DateTime @default(now()) @db.Timestamptz(6)
  created_at     DateTime @default(now()) @db.Timestamptz(6)

  @@index([actor], map: "idx_audit_logs_actor")
  @@index([timestamp], map: "idx_audit_logs_timestamp")
}

model migrations {
  id        String   @id @db.VarChar(255)
  version   String   @db.VarChar(50)
  name      String   @db.VarChar(255)
  status    String   @db.VarChar(50)
  timestamp DateTime @default(now()) @db.Timestamptz(6)
  duration  Int?
  error     String?
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model refresh_tokens {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id           String    @db.Uuid
  token             String    @unique
  expires_at        DateTime  @db.Timestamptz(6)
  revoked           Boolean?  @default(false)
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)
  replaced_by_token String?
  used              Boolean?  @default(false)
  users             users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([token], map: "idx_refresh_tokens_token")
  @@index([used], map: "idx_refresh_tokens_used")
  @@index([user_id], map: "idx_refresh_tokens_user_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model security_events {
  id                                       String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                                  String?   @db.Uuid
  event_type                               String    @db.VarChar(100)
  severity                                 String    @db.VarChar(20)
  title                                    String
  description                              String?
  metadata                                 Json?     @default("{}")
  ip_address                               String?   @db.Inet
  user_agent                               String?
  location                                 Json?
  source                                   String?   @db.VarChar(100)
  resolved                                 Boolean?  @default(false)
  resolved_at                              DateTime? @db.Timestamptz(6)
  resolved_by                              String?   @db.Uuid
  created_at                               DateTime? @default(now()) @db.Timestamptz(6)
  users_security_events_resolved_byTousers users?    @relation("security_events_resolved_byTousers", fields: [resolved_by], references: [id], onUpdate: NoAction)
  users_security_events_user_idTousers     users?    @relation("security_events_user_idTousers", fields: [user_id], references: [id], onUpdate: NoAction)

  @@index([created_at(sort: Desc)], map: "idx_security_events_created_at")
  @@index([event_type], map: "idx_security_events_event_type")
  @@index([user_id], map: "idx_security_events_user_id")
}

model security_sessions {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id            String    @db.Uuid
  token_hash         String
  refresh_token_hash String?
  device_info        Json?
  ip_address         String?   @db.Inet
  user_agent         String?
  location           Json?
  is_active          Boolean?  @default(true)
  last_activity_at   DateTime? @default(now()) @db.Timestamptz(6)
  expires_at         DateTime  @db.Timestamptz(6)
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
  updated_at         DateTime? @default(now()) @db.Timestamptz(6)
  users              users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([token_hash], map: "idx_security_sessions_token_hash")
  @@index([user_id], map: "idx_security_sessions_user_id")
}

model security_settings {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  setting_key   String    @unique @db.VarChar(100)
  setting_value Json
  description   String?
  category      String    @db.VarChar(50)
  updated_by    String?   @db.Uuid
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  updated_at    DateTime? @default(now()) @db.Timestamptz(6)
  users         users?    @relation(fields: [updated_by], references: [id], onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model users {
  id                                                            String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                                                         String                @unique @db.VarChar(255)
  password_hash                                                 String?
  first_name                                                    String?               @db.VarChar(100)
  last_name                                                     String?               @db.VarChar(100)
  username                                                      String?               @unique @db.VarChar(100)
  avatar_url                                                    String?
  is_verified                                                   Boolean?              @default(false)
  is_active                                                     Boolean?              @default(true)
  role                                                          String?               @default("student") @db.VarChar(50)
  permissions                                                   String[]              @default([])
  google_id                                                     String?               @unique @db.VarChar(255)
  google_email                                                  String?               @db.VarChar(255)
  oauth_provider                                                String?               @db.VarChar(50)
  oauth_linked_at                                               DateTime?             @db.Timestamptz(6)
  permission_source                                             String?               @default("default") @db.VarChar(50)
  simulation_role                                               String?               @db.VarChar(50)
  simulation_active                                             Boolean?              @default(false)
  created_at                                                    DateTime?             @default(now()) @db.Timestamptz(6)
  updated_at                                                    DateTime?             @default(now()) @db.Timestamptz(6)
  whitelist_entry_id                                            String?               @db.Uuid
  refresh_tokens                                                refresh_tokens[]
  security_events_security_events_resolved_byTousers            security_events[]     @relation("security_events_resolved_byTousers")
  security_events_security_events_user_idTousers                security_events[]     @relation("security_events_user_idTousers")
  security_sessions                                             security_sessions[]
  security_settings                                             security_settings[]
  whitelist_entries_users_whitelist_entry_idTowhitelist_entries whitelist_entries?    @relation("users_whitelist_entry_idTowhitelist_entries", fields: [whitelist_entry_id], references: [id], onUpdate: NoAction)
  verification_tokens                                           verification_tokens[]
  whitelist_entries_whitelist_entries_granted_byTousers         whitelist_entries[]   @relation("whitelist_entries_granted_byTousers")
  changelog_entries                                             changelog_entries[]
  changelog_feedback                                            changelog_feedback[]

  @@index([email], map: "idx_users_email")
  @@index([permission_source], map: "idx_users_permission_source")
  @@index([role], map: "idx_users_role")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model verification_tokens {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  token      String    @unique @db.VarChar(64)
  type       String    @db.VarChar(50)
  expires_at DateTime  @db.Timestamptz(6)
  used       Boolean?  @default(false)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([token], map: "idx_verification_tokens_token")
  @@index([user_id], map: "idx_verification_tokens_user_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model whitelist_entries {
  id                                                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                                             String    @unique @db.VarChar(255)
  permission_level                                  String    @db.VarChar(50)
  permissions                                       String[]  @default([])
  granted_by                                        String?   @db.Uuid
  granted_at                                        DateTime? @default(now()) @db.Timestamptz(6)
  expires_at                                        DateTime? @db.Timestamptz(6)
  is_active                                         Boolean?  @default(true)
  is_permanent                                      Boolean?  @default(false)
  notes                                             String?
  created_at                                        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at                                        DateTime? @default(now()) @db.Timestamptz(6)
  users_users_whitelist_entry_idTowhitelist_entries users[]   @relation("users_whitelist_entry_idTowhitelist_entries")
  users_whitelist_entries_granted_byTousers         users?    @relation("whitelist_entries_granted_byTousers", fields: [granted_by], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([email], map: "idx_whitelist_email")
  @@index([permission_level], map: "idx_whitelist_permission_level")
}

model changelog_entries {
  id                String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  version           String               @db.VarChar(50)
  title             String
  slug              String               @unique
  summary           String?
  content_html      String
  category          changelog_category
  author_id         String?              @db.Uuid
  status            changelog_status     @default(draft)
  is_for_students   Boolean              @default(true)
  is_for_teachers   Boolean              @default(false)
  is_for_developers Boolean              @default(false)
  published_at      DateTime?            @db.Timestamptz(6)
  created_at        DateTime             @default(now()) @db.Timestamptz(6)
  updated_at        DateTime             @default(now()) @db.Timestamptz(6)
  users             users?               @relation(fields: [author_id], references: [id], onUpdate: NoAction)
  changelog_feedback changelog_feedback[]

  @@index([published_at(sort: Desc)], map: "idx_changelog_published")
}

model changelog_feedback {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  entry_id      String            @db.Uuid
  user_id       String?           @db.Uuid
  reaction_type String?           @db.VarChar(20)
  comment_text  String?
  created_at    DateTime          @default(now()) @db.Timestamptz(6)
  changelog_entries changelog_entries @relation(fields: [entry_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users         users?            @relation(fields: [user_id], references: [id], onUpdate: NoAction)

  @@index([entry_id], map: "idx_changelog_feed_entry")
}

enum changelog_category {
  new
  improved
  fixed
  breaking
  internal
}

enum changelog_status {
  draft
  published
  archived
}
