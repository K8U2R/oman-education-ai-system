<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Bridge Sentinel | فاحص الجسر السيادي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'IBM+Plex+Sans+Arabic', sans-serif; }
        .glass { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .terminal { background: #0a0a0a; border: 1px solid #333; }
        .success-glow { box-shadow: 0 0 15px rgba(34, 197, 94, 0.3); }
        .error-glow { box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .critical-error { animation: pulse-red 1s infinite; color: #ef4444; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto space-y-6">
        <!-- Header -->
        <header class="flex justify-between items-center glass p-6 rounded-2xl">
            <div>
                <h1 class="text-2xl font-bold text-blue-400">فاحص الجسر السيادي <span class="text-sm font-mono opacity-50">v1.0.0</span></h1>
                <p class="text-gray-400 text-sm mt-1">Lead Diagnostic Probe: Backend Connectivity Inspector</p>
            </div>
            <div id="connection-status" class="px-4 py-1 rounded-full bg-gray-800 text-xs border border-gray-700">
                الحالة: <span class="text-yellow-400">بانتظار الفحص</span>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Progress Stages -->
            <div class="md:col-span-2 space-y-6">
                
                <!-- Stage 1: Health -->
                <section id="stage-1" class="glass p-6 rounded-2xl transition-all duration-500">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <span class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-sm ml-3">1</span>
                            فحص الجاهزية (Health Check)
                        </h2>
                        <span id="badge-1" class="text-xs px-2 py-1 rounded border border-gray-700 opacity-50">غير متوفر</span>
                    </div>
                    <p class="text-sm text-gray-400 mb-4">التحقق من أن الخادم الأساسي يعمل ويستقبل الطلبات.</p>
                    <button onclick="checkHealth()" id="btn-health" class="w-full py-2 bg-blue-600 hover:bg-blue-500 rounded-xl transition-colors font-semibold">بدء الفحص</button>
                </section>

                <!-- Stage 2: Auth -->
                <section id="stage-2" class="glass p-6 rounded-2xl opacity-40 pointer-events-none transition-all duration-500">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <span class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-sm ml-3">2</span>
                            المصادقة (Authentication)
                        </h2>
                        <span id="badge-2" class="text-xs px-2 py-1 rounded border border-gray-700 opacity-50">مقفل</span>
                    </div>
                    <div class="space-y-3 mb-4">
                        <input type="email" id="email" placeholder="البريد الإلكتروني" class="w-full bg-gray-900 border border-gray-800 rounded-lg p-2 text-sm focus:border-blue-500 outline-none">
                        <input type="password" id="password" placeholder="كلمة المرور" class="w-full bg-gray-900 border border-gray-800 rounded-lg p-2 text-sm focus:border-blue-500 outline-none">
                    </div>
                    <button onclick="login()" id="btn-login" class="w-full py-2 bg-purple-600 hover:bg-purple-500 rounded-xl transition-colors font-semibold">تسجيل الدخول</button>
                </section>

                <!-- Stage 3: Data -->
                <section id="stage-3" class="glass p-6 rounded-2xl opacity-40 pointer-events-none transition-all duration-500">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <span class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-sm ml-3">3</span>
                            جلب البيانات (Data Bridge)
                        </h2>
                        <span id="badge-3" class="text-xs px-2 py-1 rounded border border-gray-700 opacity-50">مقفل</span>
                    </div>
                    <p class="text-sm text-gray-400 mb-4">اختبار الوصول إلى الملف الشخصي باستخدام رمز الوصول (Access Token).</p>
                    <button onclick="fetchMe()" id="btn-me" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 rounded-xl transition-colors font-semibold">جلب البروفايل</button>
                    <div id="user-info" class="mt-4 p-3 bg-gray-900 rounded-lg hidden text-xs font-mono overflow-auto max-h-32"></div>
                </section>
            </div>

            <!-- Visual Console -->
            <div class="md:col-span-1 border-r md:border-r-0 md:border-t-0 border-gray-800">
                <div class="glass h-full rounded-2xl flex flex-col">
                    <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">System Console</h3>
                        <button onclick="clearLogs()" class="text-[10px] text-gray-600 hover:text-gray-400 uppercase">Clear</button>
                    </div>
                    <div id="console" class="p-4 flex-1 text-[11px] font-mono space-y-2 overflow-y-auto max-h-[600px] leading-relaxed">
                        <div class="text-gray-500 italic">[00:00:00] Initializing Bridge Sentinel...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            BASE_URL: 'http://localhost:30000',
            TIMEOUT: 10000 // 10 seconds
        };

        let AUTH_TOKEN = null;

        /**
         * Core Law 1: Strict Timeout Fetch
         */
        async function sentinelFetch(endpoint, options = {}) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);
            
            const start = performance.now();
            log(`إرسال طلب إلى: ${endpoint}...`);

            try {
                const response = await fetch(`${CONFIG.BASE_URL}${endpoint}`, {
                    ...options,
                    signal: controller.signal
                });
                
                clearTimeout(id);
                const end = performance.now();
                const latency = (end - start).toFixed(2);
                
                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({}));
                    throw new Error(errorJson.error || `HTTP ${response.status}`);
                }
                
                log(`تم الاستلام بنجاح. Latency: ${latency}ms`, 'success');
                return await response.json();
            } catch (error) {
                clearTimeout(id);
                if (error.name === 'AbortError') {
                    log('CRITICAL TIMEOUT ERROR (قانون المهلة الصارمة)', 'error');
                    log('التشخيص: الخادم لا يستجيب أو جدار الحماية يمنع الحركة.', 'error');
                    alertCritical('CRITICAL TIMEOUT ERROR: خرق قانون الـ 10 ثواني');
                } else {
                    log(`خطأ في الطلب: ${error.message}`, 'error');
                }
                throw error;
            }
        }

        /**
         * UI State Management (Core Law 2)
         */
        function unlockStage(stageId) {
            const stage = document.getElementById(`stage-${stageId}`);
            const badge = document.getElementById(`badge-${stageId}`);
            stage.style.opacity = '1';
            stage.style.pointerEvents = 'auto';
            stage.classList.add('success-glow');
            badge.innerText = 'متاح';
            badge.classList.replace('opacity-50', 'text-green-400');
            badge.classList.replace('border-gray-700', 'border-green-500/30');
            
            if (stageId === 1) {
                document.getElementById('connection-status').innerHTML = 'الحالة: <span class="text-green-400">الخادم متصل</span>';
            }
        }

        /**
         * Stage Functions
         */
        async function checkHealth() {
            setLoading('btn-health', true);
            try {
                await sentinelFetch('/health');
                unlockStage(1);
                unlockStage(2); // Unlock login next
            } catch (e) {}
            setLoading('btn-health', false);
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                log('يرجى إدخال البيانات للمصادقة', 'warn');
                return;
            }

            setLoading('btn-login', true);
            try {
                const data = await sentinelFetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                AUTH_TOKEN = data.token || data.data?.token;
                log('تم حفظ رمز الوصول بنجاح.', 'success');
                unlockStage(2);
                unlockStage(3);
            } catch (e) {}
            setLoading('btn-login', false);
        }

        async function fetchMe() {
            if (!AUTH_TOKEN) {
                log('لا يوجد رمز وصول صالح.', 'error');
                return;
            }

            setLoading('btn-me', true);
            try {
                const data = await sentinelFetch('/api/v1/auth/me', {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                const infoBox = document.getElementById('user-info');
                infoBox.classList.remove('hidden');
                infoBox.innerText = JSON.stringify(data, null, 2);
                unlockStage(3);
                log('Journey Complete: تم جلب جميع البيانات بنجاح.', 'success');
            } catch (e) {}
            setLoading('btn-me', false);
        }

        /**
         * Utilities
         */
        function log(msg, type = 'info') {
            const consoleEl = document.getElementById('console');
            const time = new Date().toLocaleTimeString('en-GB', { hour12: false });
            const item = document.createElement('div');
            
            let colorClass = 'text-gray-400';
            if (type === 'success') colorClass = 'text-green-400';
            if (type === 'error') colorClass = 'text-red-500 font-bold';
            if (type === 'warn') colorClass = 'text-yellow-400 font-semibold';

            item.innerHTML = `<span class="text-gray-600">[${time}]</span> <span class="${colorClass}">${msg}</span>`;
            consoleEl.appendChild(item);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function setLoading(btnId, isLoading) {
            const btn = document.getElementById(btnId);
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = '<span class="animate-spin inline-block mr-2">⚙️</span> جاري الفحص...';
                btn.classList.add('opacity-70');
            } else {
                btn.disabled = false;
                btn.innerHTML = btnId === 'btn-health' ? 'بدء الفحص' : (btnId === 'btn-login' ? 'تسجيل الدخول' : 'جلب البروفايل');
                btn.classList.remove('opacity-70');
            }
        }

        function alertCritical(msg) {
            const status = document.getElementById('connection-status');
            status.innerHTML = `<span class="critical-error">${msg}</span>`;
        }

        function clearLogs() {
            document.getElementById('console').innerHTML = '';
            log('Console cleared.', 'info');
        }

        // Initialize clock in logs
        log('Sovereign Bridge Sentinel initialized. Laws Locked.', 'warn');
        log('URL المستهدف: ' + CONFIG.BASE_URL, 'info');

    </script>
</body>
</html>
