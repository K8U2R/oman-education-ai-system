# خطة التنفيذ: نظام البيئة المعياري (Modular Env)

## الملخص
إعادة بناء نظام إدارة متغيرات البيئة للانتقال من ملف `.env` مركزي إلى بنية معيارية (`env/`) مع التحقق الصارم من الصحة (Validation) باستخدام `zod`، وضمان أولوية متغيرات النظام (System Sovereignty).

## السياق التقني
- **اللغة**: TypeScript (Node.js for Backend).
- **المكتبات**: `dotenv` (موجودة)، `zod` (للتحقق من الصحة).
- **الهدف**: القضاء على القيم الثابتة (Hardcoded Values) وتسهيل إدارة الإعدادات.

## هيكل المشروع المقترح
```text
apps/backend/env/
├── .env.defaults       # القيم الافتراضية الآمنة
├── .env.base           # الإعدادات العامة
├── .env.database       # إعدادات قاعدة البيانات
├── .env.security       # الأسرار والمفاتيح
├── schema.ts           # مخطط التحقق (Zod Schema)
└── loader.ts           # منطق التجميع والتحميل
```

## المراحل (Phases)

### المرحلة 1: الإعداد (Setup)
**الهدف**: تهيئة البنية التحتية للمجلدات والمكتبات.
1.  إنشاء مجلد `apps/backend/env`.
2.  تحديث `.gitignore` لاستثناء الملفات السرية والسماح بالافتراضيات.
3.  التأكد من وجود مكتبة `zod`.

### المرحلة 2: التنفيذ الأساسي (Core Implementation)
**الهدف**: بناء "محرك" البيئة الجديد.
1.  **المخطط (Schema)**: تعريف `zod` schema صارم يشمل جميع المتغيرات المطلوبة.
2.  **القيم الافتراضية**: إنشاء `.env.defaults` بقيم آمنة للتطوير.
3.  **المحمل (Loader)**: كتابة سكربت يقوم بـ:
    - تحميل `.env.defaults`.
    - دمج ملفات `.env.*` الموجودة.
    - إعطاء الأولوية لـ `process.env` (بما في ذلك متغيرات Docker).
    - التحقق من النتيجة باستخدام `schema.parse`.

### المرحلة 3: الهجرة (Migration)
**الهدف**: نقل المتغيرات الحالية إلى البنية الجديدة.
1.  تقسيم محتويات `.env` الحالي إلى `.env.base`, `.env.database`, إلخ.
2.  حذف القيم الثابتة المتبقية في الكود (مثل `localhost`).

### المرحلة 4: التكامل (Integration)
**الهدف**: ربط النظام الجديد بالتطبيق.
1.  تحديث `apps/backend/src/infrastructure/config/env.config.ts` لاستخدام المحمل الجديد.
2.  إزالة الاعتماد القديم على `dotenv.config()` البسيط.

## خطة التحقق
- **اختبار الوحدة**: التأكد من أن المحمل يرفض التشغيل عند نقص متغير مطلوب.
- **اختبار التكامل**: تشغيل الخادم والتأكد من اتصاله بقاعدة البيانات باستخدام الإعدادات الجديدة.
- **تدقيق الكود**: البحث عن أي سلسلة نصية `localhost` أو `3000` للتأكد من إزالتها.
