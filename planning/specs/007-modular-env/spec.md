# المواصفات: نظام البيئة المعياري (Modular Environment System)

## 1. المقدمة
يهدف نظام البيئة المعياري إلى استبدال ملفات `.env` المتضخمة والمركزية بنهج معياري (Modular) وقابل للتوسع. يعالج هذا النظام مشكلة "تبعثر المتغيرات" وصعوبة الصيانة عند نمو المشروع، ويضمن عدم وجود أي قيم "Hardcoded" (مثل `localhost` أو المنافذ) داخل الكود المصدري، مع توفير هيكلية واضحة لفصل الإعدادات حسب الوظيفة (قاعدة البيانات، الخدمات الخارجية، الأمان).

## 2. قصص المستخدم (User Stories)
- **كمطور**، أريد إضافة مفاتيح API لخدمة جديدة في ملف منفصل (مثل `.env.ai`) بدلاً من البحث في ملف ضخم يحتوي على 100 سطر، لتقليل تضارب الدمج (Merge Conflicts).
- **كمسؤول نظام (DevOps)**، أريد أن أعرف بوضوح ما هي المنافذ والمتغيرات المطلوبة لكل خدمة من خلال توثيق موحد وهيكلية ملفات واضحة (`env/`).
- **كمدقق أمني**، أريد التأكد من أن الأسرار (Secrets) مفصولة عن الإعدادات العامة، وأن الكود لا يحتوي على أي قيم افتراضية غير آمنة.
- **كمطور جديد**، أريد أن يعمل النظام معي مباشرة بعد تشغيل سكربت الإعداد دون الحاجة لتخمين المتغيرات الناقصة.

## 3. المتطلبات التقنية

### 3.1 معيار هيكلة الملفات (File Structure Standard)
يجب اتباع الهيكلية التالية داخل كل تطبيق (أو في الجذر المشترك):
```text
root/
├── env/                   # المجلد الموحد للإعدادات
│   ├── .env.base          # الإعدادات الأساسية (الاسم، البيئة، الروابط العامة)
│   ├── .env.database      # إعدادات الاتصال بقواعد البيانات (Postgres, Redis)
│   ├── .env.security      # المفاتيح السرية والتشفير (JWT, Session Secrets)
│   ├── .env.google        # إعدادات Google OAuth
│   └── .env.features      # أعلام الميزات (Feature Flags)
├── load-env.ts            # سكربت التحميل الذي يدمج هذه الملفات في process.env
└── ...
```

### 3.2 آلية التحميل (Loading Mechanism)
- يجب عدم الاعتماد على `dotenv` التقليدي الذي يقرأ ملفاً واحداً فقط.
- يجب بناء أو استخدام أداة (مثل `dotenv-flow` أو سكربت مخصص) تقوم بدمج جميع الملفات الموجودة في مجلد `env/` وحقنها في `process.env` عند بدء التشغيل.
- **الأولوية السيادية**: يجب أن تكون الأولوية للمتغيرات الموجودة في بيئة النظام (Shell Environment/Docker) على تلك الموجودة في الملفات المحلية.

### 3.3 حظر القيم الثابتة (No Hardcoded Values)
- يمنع منعاً باتاً استخدام `localhost` أو المنافذ (مثل `3000`, `5432`) كسلاسل نصية داخل الكود.
- يجب استخدام `ENV_CONFIG` أو `process.env` حصراً.

### 3.4 التحقق الصارم (Schema Validation)
- استخدام مكتبة `zod` لتعريف Schema لكل ملف إعدادات.
- يمنع تشغيل النظام إذا فشل التحقق (Fail Fast) مع رسالة خطأ توضح المتغير المفقود.

### 3.5 البيئة الافتراضية الذكية (Smart Defaults)
- وجود ملف `.env.defaults` يحتوي على قيم آمنة للتطوير المحلي (مثل `NODE_ENV=development`).
- يقلل الحاجة لإنشاء ملفات يدوية عند انضمام مطور جديد.

## 4. معايير القبول (Acceptance Criteria)
1.  **النجاح التشغيلي**: يعمل الخادم (Backend) والواجهة (Frontend) بنجاح باستخدام الهيكلية الجديدة للمجلد `env/`.
2.  **النظافة البرمجية**: لا يوجد أي استدعاء لـ `dotenv.config()` يشير إلى ملف `.env` الجذري القديم.
3.  **التوثيق**: وجود ملف `apps/docs/env/README.md` يشرح كيفية إضافة متغير جديد.
4.  **المرونة**: إضافة ملف جديد `.env.test` يتم تحميله تلقائياً دون تعديل الكود.

## 5. المخاطر والتخفيف
- **الخطر**: تعقيد عملية النشر (Deployment) في بيئات الإنتاج (Docker/K8s).
    - *التخفيف*: في الإنتاج، يتم حقن المتغيرات مباشرة (Environment Variables Injection) ولا يتم الاعتماد على ملفات `.env`، لذا فإن الهيكلية الجديدة تؤثر أساساً على التطوير المحلي والتوثيق، وهو أمر إيجابي.
- **الخطر**: نسيان إضافة ملف جديد إلى `.gitignore`.
    - *التخفيف*: إضافة `env/*.env*` و استثناء `env/.env.example` فقط في ملف `.gitignore` العام.
